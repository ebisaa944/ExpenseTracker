{% extends "tracker/base.html" %}
{% load static %}

{% block title %}Dashboard - ExpenseTracker{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Financial Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title">Monthly Income</h6>
                    <h3 class="card-text">${{ monthly_income|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h6 class="card-title">Monthly Expenses</h6>
                    <h3 class="card-text">${{ monthly_expenses|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title">Net Savings</h6>
                    <h3 class="card-text">${{ monthly_income|subtract:monthly_expenses|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title">Active Goals</h6>
                    <h3 class="card-text">{{ goals.count }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Charts -->
        <div class="col-md-8">
            <!-- Expense Trend Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Monthly Expense Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="expenseTrendChart" height="250"></canvas>
                </div>
            </div>

            <!-- Category Spending Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Spending by Category</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Right Column: Recent Activity & Alerts -->
        <div class="col-md-4">
            <!-- Recent Expenses -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Expenses</h5>
                </div>
                <div class="card-body">
                    {% if recent_expenses %}
                        <div class="list-group list-group-flush">
                            {% for expense in recent_expenses %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <h6 class="mb-1">{{ expense.description }}</h6>
                                    <small class="text-muted">{{ expense.category.name }} â€¢ {{ expense.date|date:"M d" }}</small>
                                </div>
                                <span class="badge bg-danger rounded-pill">${{ expense.amount }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No recent expenses</p>
                    {% endif %}
                    <div class="mt-3">
                        <a href="{% url 'tracker:expense_list' %}" class="btn btn-outline-primary btn-sm">View All Expenses</a>
                    </div>
                </div>
            </div>

            <!-- Budget Alerts -->
            {% if budget_alerts %}
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">Budget Alerts</h5>
                </div>
                <div class="card-body">
                    {% for alert in budget_alerts %}
                    <div class="alert alert-warning alert-dismissible fade show mb-2" role="alert">
                        <small>
                            <strong>{{ alert.budget.category.name }}</strong><br>
                            Spent ${{ alert.spent|floatformat:2 }} of ${{ alert.budget.amount|floatformat:2 }}
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar bg-warning" role="progressbar" 
                                     style="width: {{ alert.percentage }}%;" 
                                     aria-valuenow="{{ alert.percentage }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'tracker:expense_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Add Expense
                        </a>
                        <a href="{% url 'tracker:budget_create' %}" class="btn btn-outline-primary">
                            <i class="fas fa-chart-pie me-2"></i>Create Budget
                        </a>
                        <a href="{% url 'tracker:goal_create' %}" class="btn btn-outline-primary">
                            <i class="fas fa-bullseye me-2"></i>Set Goal
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load chart data when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Expense Trend Chart
    fetch("{% url 'tracker:expense_chart_data' %}")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('expenseTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month),
                    datasets: [{
                        label: 'Monthly Expenses',
                        data: data.map(item => item.amount),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        });

    // Category Chart
    fetch("{% url 'tracker:category_chart_data' %}")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: data.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
});
</script>
{% endblock %}